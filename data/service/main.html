<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Device Service Portal</title>
  <link rel="icon" href="/favicon.ico" />
  <link rel="stylesheet" href="/service/service.css" />
</head>
<body data-page="service">
  <main class="service-page">
    <header class="page-heading">
      <div class="heading-left">
        <h1>Weather Station</h1>
        <p class="subtitle" id="location-summary">Location: not set</p>
      </div>
      <div class="heading-actions">
        <div class="clock-banner compact" id="clock-banner">
          <div class="clock-glow"></div>
          <div class="clock-content">
            <div class="clock-row">
              <div class="clock-time" id="clock-time">--:--</div>
              <span class="clock-ms" id="clock-ms">.--- </span>
            </div>
            <div class="clock-subrow">
              <span class="clock-date" id="clock-date">—</span>
              <span class="clock-dot" aria-hidden="true">•</span>
              <span class="clock-zone" id="clock-zone">Local</span>
            </div>
          </div>
        </div>
        <button id="outdoor-setup-btn" class="button-link tertiary">Setup Clock and Weather</button>
      </div>
    </header>

    <section class="weather-service">
      <div class="weather-heading">
        <div>
          <h2>Weather Service</h2>
          <p class="subtitle">Live telemetry from SHT31 (temperature & humidity) and BMP580 (pressure & altitude) sensors.</p>
        </div>
        <div class="weather-controls">
          <label for="weather-interval">Refresh every</label>
          <select id="weather-interval">
            <option value="2000">2 s</option>
            <option value="5000">5 s</option>
            <option value="10000">10 s</option>
            <option value="30000">30 s</option>
            <option value="60000" selected>60 s</option>
            <option value="180000">3 min</option>
            <option value="300000">5 min</option>
            <option value="600000">10 min</option>
            <option value="1800000">30 min</option>
            <option value="3600000">60 min</option>
          </select>
        </div>
      </div>

      <div class="status" id="weather-status" hidden></div>

      <div class="weather-grid">
        <div class="sensor-block">
          <div class="block-header">
            <div>
              <h3>Temperature & Humidity</h3>
              <p class="block-sub">Sensor: <span id="sensor-sht31-status" class="sensor-state">—</span></p>
            </div>
          </div>
          <div class="weather-tiles">
            <article class="weather-tile temperature">
              <h3 class="tile-title">Temperature</h3>
              <div class="metric-pair">
                <div class="metric-line">
                  <span class="metric-label indoor">Indoor</span>
                  <span class="weather-value compact"><span id="weather-temp-indoor">—</span><span class="unit">°C</span></span>
                  <span class="metric-sub" id="weather-temp-f-indoor">— °F</span>
                </div>
                <div class="metric-line metric-outdoor-temp">
                  <span class="metric-label outdoor" data-metric="temp">Outdoor</span>
                  <span class="weather-value compact"><span id="weather-temp-outdoor">—</span><span class="unit">°C</span></span>
                  <span class="metric-sub" id="weather-temp-f-outdoor">— °F</span>
                  <span class="condition-inline condition-inline-main" id="outdoor-condition-icon"></span>
                </div>
              </div>
              <p class="weather-sub">Dew point <span id="weather-dewpoint">—</span> °C</p>
            </article>

            <article class="weather-tile humidity">
              <h3 class="tile-title">Humidity</h3>
              <div class="metric-pair">
                <div class="metric-line">
                  <span class="metric-label indoor">Indoor</span>
                  <span class="weather-value compact"><span id="weather-humidity-indoor">—</span><span class="unit">%</span></span>
                </div>
                <div class="metric-line">
                  <span class="metric-label outdoor" data-metric="humidity">Outdoor</span>
                  <span class="weather-value compact"><span id="weather-humidity-outdoor">—</span><span class="unit">%</span></span>
                </div>
              </div>
              <p class="weather-sub wind-row">
                <span class="wind-chip" aria-hidden="true">Wind</span>
                <span class="wind-value"><span id="weather-wind-outdoor">—</span> m/s</span>
              </p>
            </article>
          </div>
        </div>

        <div class="sensor-block">
          <div class="block-header">
            <div>
              <h3>Pressure & Altitude</h3>
              <p class="block-sub">Sensor: <span id="sensor-bmp580-status" class="sensor-state">—</span></p>
            </div>
          </div>
          <div class="weather-tiles">
            <article class="weather-tile pressure">
              <h3 class="tile-title">Pressure</h3>
              <div class="metric-pair">
                <div class="metric-line">
                  <span class="metric-label indoor">Indoor</span>
                  <span class="weather-value compact"><span id="weather-pressure-indoor">—</span><span class="unit">mmHg</span></span>
                  <span class="metric-sub" id="weather-pressure-hpa-indoor">— hPa</span>
                </div>
                <div class="metric-line">
                  <span class="metric-label outdoor" data-metric="pressure">Outdoor</span>
                  <span class="weather-value compact"><span id="weather-pressure-outdoor">—</span><span class="unit">mmHg</span></span>
                  <span class="metric-sub" id="weather-pressure-hpa-outdoor">— hPa</span>
                </div>
              </div>
            </article>

            <article class="weather-tile altitude">
              <h3 class="tile-title">Altitude</h3>
              <div class="metric-pair">
                <div class="metric-line">
                  <span class="metric-label indoor">Indoor</span>
                  <span class="weather-value compact"><span id="weather-altitude-indoor">—</span><span class="unit">m</span></span>
                  <span class="metric-sub" id="weather-altitude-ft-indoor">— ft</span>
                </div>
                <div class="metric-line">
                  <span class="metric-label outdoor">Outdoor</span>
                  <span class="weather-value compact"><span id="weather-altitude-outdoor">—</span><span class="unit">m</span></span>
                  <span class="metric-sub" id="weather-altitude-ft-outdoor">— ft</span>
                </div>
              </div>
            </article>
          </div>
        </div>

        <div class="weather-chart-card">
          <header>
            <h3>Temperature & Humidity</h3>
            <p>Tracked across the past 24 hours. Tap to open the 7-day view.</p>
          </header>
          <canvas id="weather-chart" class="trend-canvas"></canvas>
          <div class="chart-legend">
            <span class="legend-item temp-in" data-series="tempIn">Temp indoor</span>
            <span class="legend-item temp-out" data-series="tempOut">Temp outdoor</span>
            <span class="legend-item humidity-in" data-series="humIn">Hum indoor</span>
            <span class="legend-item humidity-out" data-series="humOut">Hum outdoor</span>
          </div>
          <p class="weather-updated">Last updated <span id="weather-updated">—</span></p>
        </div>

        <div class="weather-chart-card pressure-card">
          <header>
            <h3>Pressure</h3>
            <p>24-hour barometric trend. Tap to open the 7-day view.</p>
          </header>
          <canvas id="pressure-chart" class="trend-canvas"></canvas>
          <div class="chart-legend">
            <span class="legend-item pressure-in" data-series="pressIn">Pressure indoor</span>
            <span class="legend-item pressure-out" data-series="pressOut">Pressure outdoor</span>
          </div>
        </div>

        <div class="forecast-block">
          <header class="forecast-header">
            <div>
              <h3>Outdoor Outlook</h3>
              <p class="subtitle">Snapshots for the next 1, 3, 6, 12, 24, 48, 72, and 96 hours.</p>
            </div>
            <div class="forecast-updated" id="forecast-updated">—</div>
          </header>
          <div class="forecast-grid" id="forecast-grid">
            <article class="forecast-card" data-horizon="1">
              <div class="forecast-horizon">+1h</div>
              <div class="forecast-condition" id="forecast-icon-1"></div>
              <div class="forecast-metrics">
                <div><span class="metric-label small temp">Temp</span><span class="forecast-value" id="forecast-temp-1">—</span></div>
                <div><span class="metric-label small humidity">Hum</span><span class="forecast-value" id="forecast-hum-1">—</span></div>
                <div><span class="metric-label small pressure">Press</span><span class="forecast-value" id="forecast-pres-1">—</span></div>
              </div>
            </article>
            <article class="forecast-card" data-horizon="3">
              <div class="forecast-horizon">+3h</div>
              <div class="forecast-condition" id="forecast-icon-3"></div>
              <div class="forecast-metrics">
                <div><span class="metric-label small temp">Temp</span><span class="forecast-value" id="forecast-temp-3">—</span></div>
                <div><span class="metric-label small humidity">Hum</span><span class="forecast-value" id="forecast-hum-3">—</span></div>
                <div><span class="metric-label small pressure">Press</span><span class="forecast-value" id="forecast-pres-3">—</span></div>
              </div>
            </article>
            <article class="forecast-card" data-horizon="6">
              <div class="forecast-horizon">+6h</div>
              <div class="forecast-condition" id="forecast-icon-6"></div>
              <div class="forecast-metrics">
                <div><span class="metric-label small temp">Temp</span><span class="forecast-value" id="forecast-temp-6">—</span></div>
                <div><span class="metric-label small humidity">Hum</span><span class="forecast-value" id="forecast-hum-6">—</span></div>
                <div><span class="metric-label small pressure">Press</span><span class="forecast-value" id="forecast-pres-6">—</span></div>
              </div>
            </article>
            <article class="forecast-card" data-horizon="12">
              <div class="forecast-horizon">+12h</div>
              <div class="forecast-condition" id="forecast-icon-12"></div>
              <div class="forecast-metrics">
                <div><span class="metric-label small temp">Temp</span><span class="forecast-value" id="forecast-temp-12">—</span></div>
                <div><span class="metric-label small humidity">Hum</span><span class="forecast-value" id="forecast-hum-12">—</span></div>
                <div><span class="metric-label small pressure">Press</span><span class="forecast-value" id="forecast-pres-12">—</span></div>
              </div>
            </article>
            <article class="forecast-card" data-horizon="24">
              <div class="forecast-horizon">+24h</div>
              <div class="forecast-condition" id="forecast-icon-24"></div>
              <div class="forecast-metrics">
                <div><span class="metric-label small temp">Temp</span><span class="forecast-value" id="forecast-temp-24">—</span></div>
                <div><span class="metric-label small humidity">Hum</span><span class="forecast-value" id="forecast-hum-24">—</span></div>
                <div><span class="metric-label small pressure">Press</span><span class="forecast-value" id="forecast-pres-24">—</span></div>
              </div>
            </article>
            <article class="forecast-card" data-horizon="48">
              <div class="forecast-horizon">+48h</div>
              <div class="forecast-condition" id="forecast-icon-48"></div>
              <div class="forecast-metrics">
                <div><span class="metric-label small temp">Temp</span><span class="forecast-value" id="forecast-temp-48">—</span></div>
                <div><span class="metric-label small humidity">Hum</span><span class="forecast-value" id="forecast-hum-48">—</span></div>
                <div><span class="metric-label small pressure">Press</span><span class="forecast-value" id="forecast-pres-48">—</span></div>
              </div>
            </article>
            <article class="forecast-card" data-horizon="72">
              <div class="forecast-horizon">+72h</div>
              <div class="forecast-condition" id="forecast-icon-72"></div>
              <div class="forecast-metrics">
                <div><span class="metric-label small temp">Temp</span><span class="forecast-value" id="forecast-temp-72">—</span></div>
                <div><span class="metric-label small humidity">Hum</span><span class="forecast-value" id="forecast-hum-72">—</span></div>
                <div><span class="metric-label small pressure">Press</span><span class="forecast-value" id="forecast-pres-72">—</span></div>
              </div>
            </article>
            <article class="forecast-card" data-horizon="96">
              <div class="forecast-horizon">+96h</div>
              <div class="forecast-condition" id="forecast-icon-96"></div>
              <div class="forecast-metrics">
                <div><span class="metric-label small temp">Temp</span><span class="forecast-value" id="forecast-temp-96">—</span></div>
                <div><span class="metric-label small humidity">Hum</span><span class="forecast-value" id="forecast-hum-96">—</span></div>
                <div><span class="metric-label small pressure">Press</span><span class="forecast-value" id="forecast-pres-96">—</span></div>
              </div>
            </article>
          </div>
        </div>
      </div>
    </section>
  </main>

  <section class="resource-section">
    <div class="resource-header">
      <div>
        <h2>Device Resources</h2>
        <p class="subtitle">Live ESP32 health: memory, flash, CPU, uptime.</p>
      </div>
      <div class="resource-updated" id="resources-updated">—</div>
    </div>
    <div class="resource-grid">
      <article class="resource-card">
        <div class="resource-label">Uptime</div>
        <div class="resource-value" id="res-uptime">—</div>
      </article>
      <article class="resource-card">
        <div class="resource-label">Heap free / min / max / used%</div>
        <div class="resource-value" id="res-heap">—</div>
      </article>
      <article class="resource-card">
        <div class="resource-label">PSRAM free / min / max / used%</div>
        <div class="resource-value" id="res-psram">—</div>
      </article>
      <article class="resource-card">
        <div class="resource-label">Flash (LittleFS)</div>
        <div class="resource-value" id="res-fs">—</div>
      </article>
      <article class="resource-card">
        <div class="resource-label">CPU freq / SDK / Rev</div>
        <div class="resource-value" id="res-cpu">—</div>
      </article>
    </div>
  </section>

  <footer class="page-footer">
    <div class="service-actions">
      <div class="action-card">
        <a href="/setup/wifi.html" class="button-link">Open Wi-Fi manager</a>
        <p class="action-desc">Configure or change Wi-Fi credentials, scan for networks, and switch between AP/STA modes.</p>
      </div>
      <div class="action-card">
        <a href="/setup/ota.html" class="button-link secondary">Open OTA portal</a>
        <p class="action-desc">Upload new firmware images over Wi-Fi. Use the FS upload endpoint for web assets.</p>
      </div>
    </div>
  </footer>

  <div id="outdoor-modal" class="modal" hidden>
    <div class="modal-dialog">
      <div class="modal-header">
        <h3>Outdoor Weather Setup</h3>
      </div>
      <div class="modal-body">
        <label class="field-label" for="outdoor-provider">Weather provider</label>
        <select id="outdoor-provider">
          <option value="open-meteo" selected>Open-Meteo (no key)</option>
          <option value="metno">MET Norway (no key)</option>
          <option value="weatherapi">WeatherAPI (key required)</option>
        </select>

        <div id="city-selectors">
        <div class="modal-section">
          <div class="section-heading">
            <div>
              <h4>Clock & Time</h4>
              <p class="subtitle">NTP source, timezone, and display preferences.</p>
            </div>
            <label class="switch">
              <input type="checkbox" id="clock-enable" />
              <span class="switch-slider"></span>
              <span class="switch-label">Show clock</span>
            </label>
          </div>

          <div class="form-grid two-col">
            <label class="field">
              <span class="field-label">Timezone mode</span>
              <select id="clock-timezone-mode">
                <option value="location">Use selected city timezone</option>
                <option value="manual">Manual timezone</option>
              </select>
              <span class="hint">Location must provide timezone; otherwise falls back to browser.</span>
            </label>

            <label class="field">
              <span class="field-label">Manual timezone</span>
              <input id="clock-timezone-manual" type="text" placeholder="e.g. Europe/Prague" list="tz-hints" />
              <datalist id="tz-hints">
                <option value="UTC"></option>
                <option value="Europe/London"></option>
                <option value="Europe/Prague"></option>
                <option value="Europe/Paris"></option>
                <option value="America/New_York"></option>
                <option value="America/Los_Angeles"></option>
                <option value="Asia/Tokyo"></option>
                <option value="Asia/Singapore"></option>
                <option value="Australia/Sydney"></option>
              </datalist>
            </label>

            <label class="field">
              <span class="field-label">Clock format</span>
              <select id="clock-format-select">
                <option value="24h">24-hour</option>
                <option value="12h">12-hour</option>
              </select>
            </label>

            <label class="field">
              <span class="field-label">Time font</span>
              <select id="clock-font-select">
                <option value="inherit">Default (system)</option>
                <option value="'Inter', 'Segoe UI', Arial, sans-serif">Inter</option>
                <option value="'Montserrat', 'Segoe UI', Arial, sans-serif">Montserrat</option>
                <option value="'Fira Code', 'SFMono-Regular', 'Consolas', monospace">Fira Code</option>
                <option value="'Poppins', 'Segoe UI', Arial, sans-serif">Poppins</option>
                <option value="'Comic Sans MS', 'Comic Sans', cursive">Comic Sans</option>
                <option value="'Marker Felt', 'Comic Sans MS', cursive">Marker Felt</option>
                <option value="'Snell Roundhand', 'Comic Sans MS', cursive">Snell Roundhand</option>
              </select>
            </label>

            <div class="field toggle-group">
              <span class="field-label">Details</span>
              <label class="toggle"><input type="checkbox" id="clock-show-seconds" checked /><span>Show seconds</span></label>
              <label class="toggle"><input type="checkbox" id="clock-show-millis" /><span>Show milliseconds</span></label>
              <label class="toggle"><input type="checkbox" id="clock-show-date" checked /><span>Show date</span></label>
              <label class="toggle"><input type="checkbox" id="clock-show-timezone" checked /><span>Show timezone</span></label>
            </div>

            <label class="field">
              <span class="field-label">NTP pools (comma separated)</span>
              <input id="clock-ntp-pools" type="text" placeholder="pool.ntp.org, time.google.com" />
              <span class="hint">Stored locally; optionally sync to device if endpoint is available.</span>
            </label>

            <label class="field">
              <span class="field-label">Sync interval (minutes)</span>
              <input id="clock-sync-interval" type="number" min="5" max="720" step="5" value="60" />
            </label>
          </div>
        </div>
          <label class="field-label" for="outdoor-search">Search city</label>
          <input id="outdoor-search" type="text" placeholder="Start typing to search" autocomplete="off" />
          <div class="search-hint" id="outdoor-search-status">Type 2+ letters to search.</div>
          <div class="search-results" id="outdoor-search-results"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="button-link secondary" id="outdoor-cancel">Cancel</button>
        <button class="button-link" id="outdoor-save">Save</button>
      </div>
    </div>
  </div>

  <div id="history-modal" class="modal" hidden>
    <div class="modal-dialog wide">
      <div class="modal-header">
        <h3>7-day History</h3>
        <button class="button-link secondary" id="history-close">Close</button>
      </div>
      <div class="modal-body history-modal-body">
        <section class="history-block">
          <div class="history-header">
            <div>
              <h4>Temperature & Humidity</h4>
              <p class="subtitle">Full week view; hover or tap for exact values.</p>
            </div>
            <div class="chart-legend">
              <span class="legend-item temp-in" data-series="tempIn">Temp indoor</span>
              <span class="legend-item temp-out" data-series="tempOut">Temp outdoor</span>
              <span class="legend-item humidity-in" data-series="humIn">Hum indoor</span>
              <span class="legend-item humidity-out" data-series="humOut">Hum outdoor</span>
            </div>
          </div>
          <div class="chart-shell">
            <canvas id="history-weather-chart" class="trend-canvas"></canvas>
          </div>
        </section>

        <section class="history-block">
          <div class="history-header">
            <div>
              <h4>Pressure</h4>
              <p class="subtitle">Full week barometric trend.</p>
            </div>
            <div class="chart-legend">
              <span class="legend-item pressure-in" data-series="pressIn">Pressure indoor</span>
              <span class="legend-item pressure-out" data-series="pressOut">Pressure outdoor</span>
            </div>
          </div>
          <div class="chart-shell">
            <canvas id="history-pressure-chart" class="trend-canvas"></canvas>
          </div>
        </section>
      </div>
    </div>
  </div>
  <script src="/service/main.js" defer></script>
</body>
</html>
